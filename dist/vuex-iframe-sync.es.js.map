{"version":3,"file":"vuex-iframe-sync.es.js","sources":["../src/utils.js","../src/const.js","../src/Observer.js","../src/Subject.js","../src/index.js"],"sourcesContent":["// type check\r\nconst oProto = Object.prototype\r\nconst toString = oProto.toString\r\nconst hasOwnProperty = oProto.hasOwnProperty\r\n\r\nexport const noop = () => {}\r\nexport const identity = _ => _\r\n\r\nfunction isType (name) {\r\n  return function (obj) {\r\n    return toString.call(obj) === '[object ' + name + ']'\r\n  }\r\n}\r\n\r\nexport const isFunction = isType('Function')\r\nexport const isArray = isType('Array')\r\n\r\nexport function cloneWithout (obj, attrs = []) {\r\n  let copy = {}\r\n  for (let attr in obj) {\r\n    attrs.indexOf(attr) < 0 && (copy[attr] = obj[attr])\r\n  }\r\n  return copy\r\n}\r\n\r\nexport function deepClone (obj) {\r\n  if (obj === null || typeof obj !== 'object') return obj\r\n\r\n  if (isDate(obj)) {\r\n    let copy = new Date()\r\n    copy.setTime(obj.getTime())\r\n    return copy\r\n  }\r\n\r\n  if (isArray(obj)) {\r\n    return obj.map(function (_) {\r\n      return deepClone(_)\r\n    })\r\n  }\r\n\r\n  if (isObject(obj)) {\r\n    let copy = {}\r\n    for (let attr in obj) {\r\n      if (hasOwnProperty.call(obj, attr)) copy[attr] = deepClone(obj[attr])\r\n    }\r\n    return copy\r\n  }\r\n}\r\n","export const staticOptions = {\r\n  moduleName: 'VI_SYNC',\r\n  childPrefix: 'CHILD_',\r\n  parentPrefix: 'PARENT_'\r\n}\r\n\r\n// mutation types\r\nexport const ADD_IN_BROADCAST_LIST = 'ADD_IN_BROADCAST_LIST'\r\nexport const DEL_IN_BROADCAST_LIST = 'DEL_IN_BROADCAST_LIST'\r\nexport const INIT_STATE = 'INIT_STATE'\r\n","import {isFunction, noop, identity} from './utils'\r\nimport {\r\n  ADD_IN_BROADCAST_LIST,\r\n  DEL_IN_BROADCAST_LIST,\r\n  INIT_STATE\r\n} from './const'\r\n\r\nexport class ObserverIframe {\r\n  constructor ({id, el, origin}) {\r\n    this.id = id\r\n    this.el = el\r\n    this.origin = origin || '*'\r\n  }\r\n\r\n  update (type, payload) {\r\n    this.el && this.el.contentWindow.postMessage({\r\n      type,\r\n      payload\r\n    }, this.origin)\r\n  }\r\n}\r\n\r\nexport class Observer {\r\n  constructor ({id, parent, store, convert, created, destroyed}) {\r\n    this.id = id\r\n    this.store = store\r\n    this.parent = parent || window.parent\r\n    this.convert = isFunction(convert) ? convert : identity\r\n\r\n    this.createdCallback = isFunction(created) ? created : noop\r\n    this.destroyedCallback = isFunction(destroyed) ? destroyed : noop\r\n    this.init()\r\n  }\r\n\r\n  init () {\r\n    const that = this\r\n    const {id, store} = this\r\n    const {_mutations: mutations} = store\r\n    const {parentPrefix, childPrefix} = Observer\r\n\r\n    // add parent mutations\r\n    Object.entries(mutations).forEach(([type, funcList]) => {\r\n      mutations[parentPrefix + type] = funcList\r\n    })\r\n    // init mutation\r\n    mutations[parentPrefix + INIT_STATE] = [payload => {\r\n      Object.assign(store.state, payload)\r\n    }]\r\n\r\n    store.subscribe(({type, payload}, state) => {\r\n      if (type.indexOf(parentPrefix) >= 0) return\r\n      that.send(childPrefix + type, {id, payload})\r\n    })\r\n\r\n    // add addEventListener\r\n    window.addEventListener('load', this.load.bind(this))\r\n    window.addEventListener('message', this.update.bind(this))\r\n    window.addEventListener('beforeunload', this.unLoad.bind(this))\r\n  }\r\n  update ({ data: {type, payload} }) {\r\n    const {store} = this\r\n    if ((!type || !Reflect.has(store._mutations, type)) && type !== INIT_STATE) return\r\n    const {parentPrefix} = Observer\r\n    store.commit(parentPrefix + type, payload)\r\n  }\r\n\r\n  send (type, payload) {\r\n    this.parent && this.parent.postMessage({\r\n      type,\r\n      payload: this.convert(payload)\r\n    }, this.parent.location && this.parent.location.origin)\r\n  }\r\n\r\n  load () {\r\n    this.send(`${Observer.moduleName}/${ADD_IN_BROADCAST_LIST}`, this.id)\r\n    this.created()\r\n  }\r\n  unLoad () {\r\n    this.send(`${Observer.moduleName}/${DEL_IN_BROADCAST_LIST}`, this.id)\r\n    this.destroyed()\r\n  }\r\n\r\n  // hook\r\n  created () {\r\n    this.createdCallback(this.id, this.store, this.send.bind(this))\r\n  }\r\n  destroyed () {\r\n    this.destroyedCallback(this.id, this.store, this.send.bind(this))\r\n  }\r\n}\r\n\r\nObserver.moduleName = ''\r\nObserver.parentPrefix = ''\r\nObserver.childPrefix = ''\r\n","import {ObserverIframe} from './Observer'\r\nimport {isFunction, isArray, cloneWithout, identity} from './utils'\r\nimport {\r\n  ADD_IN_BROADCAST_LIST,\r\n  DEL_IN_BROADCAST_LIST,\r\n  INIT_STATE\r\n} from './const'\r\n\r\nexport default class Subject {\r\n  constructor ({ids, store, convert}) {\r\n    this.childs = typeof ids === 'string'\r\n      ? ids.split(',').map(_ => ({id: _}))\r\n      : isArray(ids)\r\n      ? ids\r\n      : []\r\n    this.observerList = []\r\n    this.store = store\r\n    this.convert = isFunction(convert) ? convert : identity\r\n\r\n    this.init()\r\n  }\r\n\r\n  addObserver (id) {\r\n    let child = this.childs.find(_ => _.id === id)\r\n    if (!child) return\r\n    const iframe = document.getElementById(id)\r\n    if (iframe && iframe.tagName === 'IFRAME') {\r\n      let observer = new ObserverIframe({id, origin: child.origin, el: iframe})\r\n      this.observerList.push(observer)\r\n      // initialization sync\r\n      this.notifyObserver(observer, {\r\n        type: INIT_STATE,\r\n        payload: cloneWithout(this.store.state, [Subject.moduleName])\r\n      })\r\n      return observer\r\n    }\r\n  }\r\n\r\n  deleteObserver (id) {\r\n    const index = this.observerList.map(_ => _.id).indexOf(id)\r\n    index >= 0 && this.observerList.splice(index, 1)\r\n  }\r\n\r\n  notifyObserver (obs, {type, payload}) {\r\n    obs.update(type, this.convert(payload))\r\n  }\r\n\r\n  notifyObservers ({id, type, payload}) {\r\n    for (let obs of this.observerList.filter(_ => _.id !== id)) {\r\n      this.notifyObserver(obs, {type, payload})\r\n    }\r\n  }\r\n\r\n  init () {\r\n    const that = this\r\n    const {_mutations: mutations} = that.store\r\n    const {moduleName, childPrefix} = Subject\r\n\r\n    that.store.registerModule(moduleName, {\r\n      namespaced: true,\r\n      mutations: {\r\n        [ADD_IN_BROADCAST_LIST] (state, id) {\r\n          that.addObserver(id)\r\n        },\r\n        [DEL_IN_BROADCAST_LIST] (state, id) {\r\n          that.deleteObserver(id)\r\n        }\r\n      }\r\n    })\r\n\r\n    // add child mutations\r\n    Object.entries(mutations).forEach(([type, funcList]) => {\r\n      mutations[childPrefix + type] = funcList.map(f => ({id, payload}) => {\r\n        f(payload)\r\n        that.notifyObservers({id, type, payload})\r\n      })\r\n    })\r\n\r\n    const VALID_TYPE_RE = new RegExp(`^(${childPrefix}|${moduleName})`)\r\n    that.store.subscribe(({type, payload}, state) => {\r\n      if (VALID_TYPE_RE.test(type)) return\r\n      that.notifyObservers({type, payload})\r\n    })\r\n\r\n    window.addEventListener('message', this.update.bind(this))\r\n  }\r\n\r\n  update ({ data: {type, payload} }) {\r\n    const {store} = this\r\n    if (!type || !Reflect.has(store._mutations, type)) return\r\n    store.commit(type, payload)\r\n  }\r\n}\r\n\r\nSubject.moduleName = ''\r\nSubject.parentPrefix = ''\r\nSubject.childPrefix = ''\r\n","import Subject from './Subject'\r\nimport {Observer} from './Observer'\r\nimport {staticOptions} from './const'\r\n\r\n// sync from parent to iframe\r\nexport const broadcast = (ids, options = {}) => store => {\r\n  let {moduleName, parentPrefix, childPrefix, convert} = options\r\n  Subject.moduleName = moduleName || staticOptions.moduleName\r\n  Subject.parentPrefix = parentPrefix || staticOptions.parentPrefix\r\n  Subject.childPrefix = childPrefix || staticOptions.childPrefix\r\n\r\n  return new Subject({ids, store, convert})\r\n}\r\n\r\n// sync from iframe to parent or other iframe\r\nexport const transfer = (options = {}) => store => {\r\n  let {moduleName, parentPrefix, childPrefix, convert, created, destroyed} = options\r\n  Observer.moduleName = moduleName || staticOptions.moduleName\r\n  Observer.parentPrefix = parentPrefix || staticOptions.parentPrefix\r\n  Observer.childPrefix = childPrefix || staticOptions.childPrefix\r\n\r\n  return new Observer({\r\n    id: options.id || window.frameElement.id,\r\n    store,\r\n    convert,\r\n    created,\r\n    destroyed\r\n  })\r\n}\r\n"],"names":["const","toString","Object","prototype","noop","identity","_","isType","name","obj","call","isFunction","isArray","staticOptions","ObserverIframe","ref","el","origin","id","update","type","payload","this","contentWindow","postMessage","Observer","parent","store","convert","created","destroyed","window","createdCallback","destroyedCallback","init","that","mutations","parentPrefix","childPrefix","entries","forEach","assign","state","subscribe","indexOf","send","addEventListener","load","bind","unLoad","Reflect","has","_mutations","commit","location","moduleName","Subject","ids","childs","split","map","observerList","addObserver","child","find","iframe","document","getElementById","tagName","observer","push","notifyObserver","attrs","let","copy","attr","cloneWithout","deleteObserver","index","splice","obs","notifyObservers","filter","registerModule","f","VALID_TYPE_RE","RegExp","test","broadcast","options","transfer","frameElement"],"mappings":"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"}